---
/**
 * Lazy Loading Picture Component
 *
 * Optimized image component with:
 * - Lazy loading for below-fold images
 * - Modern format support (AVIF, WebP)
 * - Responsive images with srcset
 * - Proper accessibility attributes
 *
 * Usage:
 * <LazyPicture
 *   src="/images/example.jpg"
 *   alt="Description"
 *   widths={[320, 640, 1280]}
 *   loading="lazy"
 *   priority={false}
 * />
 *
 * Requirements:
 * - 13.3: Lazy loading for below-fold images
 * - 13.4: Optimize assets with WebP format
 */

interface Props {
  /**
   * Image source (path to image file)
   */
  src: string

  /**
   * Alternative text for accessibility (required)
   */
  alt: string

  /**
   * Image widths for responsive srcset
   * @default [320, 640, 960, 1280]
   */
  widths?: number[]

  /**
   * Loading strategy
   * - "lazy": Load when near viewport (default for below-fold)
   * - "eager": Load immediately (for above-fold/LCP)
   * @default "lazy"
   */
  loading?: 'lazy' | 'eager'

  /**
   * Priority hint for LCP images
   * Set to true for Largest Contentful Paint candidate
   * @default false
   */
  priority?: boolean

  /**
   * CSS class names
   */
  class?: string

  /**
   * Image formats to generate
   * @default ['avif', 'webp']
   */
  formats?: ('avif' | 'webp' | 'jpeg' | 'png')[]

  /**
   * Aspect ratio (optional, prevents layout shift)
   * Format: "width/height" e.g., "16/9", "4/3"
   */
  aspectRatio?: string
}

const {
  src,
  alt,
  widths = [320, 640, 960, 1280],
  loading = 'lazy',
  priority = false,
  class: className = '',
  formats = ['avif', 'webp'],
  aspectRatio,
} = Astro.props

// Determine if this is a priority/LCP image
const fetchPriority = priority ? 'high' : 'auto'
const decoding = priority ? 'sync' : 'async'

// Calculate aspect ratio padding for layout stability
const aspectRatioPadding = aspectRatio
  ? (() => {
      const [width, height] = aspectRatio.split('/').map(Number)
      return (height / width) * 100
    })()
  : null
---

<picture class={`lazy-picture ${className}`}>
  {/* AVIF format (best compression) */}
  {formats.includes('avif') && (
    <source
      type="image/avif"
      srcset={widths.map((w) => `${src}?w=${w}&format=avif ${w}w`).join(', ')}
      sizes="(min-width: 1280px) 1280px, (min-width: 960px) 960px, (min-width: 640px) 640px, 320px"
    />
  )}

  {/* WebP format (good compression + wide support) */}
  {formats.includes('webp') && (
    <source
      type="image/webp"
      srcset={widths.map((w) => `${src}?w=${w}&format=webp ${w}w`).join(', ')}
      sizes="(min-width: 1280px) 1280px, (min-width: 960px) 960px, (min-width: 640px) 640px, 320px"
    />
  )}

  {/* Fallback to original format */}
  <img
    src={src}
    alt={alt}
    loading={loading}
    decoding={decoding}
    fetchpriority={fetchPriority}
    class={aspectRatioPadding ? 'lazy-picture__img' : ''}
  />
</picture>

<style>
  .lazy-picture {
    display: block;
    position: relative;
    overflow: hidden;
  }

  /* Aspect ratio container to prevent layout shift */
  .lazy-picture:has(.lazy-picture__img) {
    position: relative;
    width: 100%;
  }

  .lazy-picture:has(.lazy-picture__img)::before {
    content: '';
    display: block;
    padding-bottom: var(--aspect-ratio-padding, 56.25%); /* Default 16:9 */
  }

  .lazy-picture__img {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  /* Loading state (optional blur-up effect) */
  img[loading='lazy']:not([src]) {
    filter: blur(10px);
    transition: filter 0.3s ease-in-out;
  }

  img[loading='lazy'][src] {
    filter: blur(0);
  }

  /* Ensure images are accessible */
  img {
    max-width: 100%;
    height: auto;
  }
</style>

<script>
  // Inline aspect ratio padding if provided
  if (aspectRatioPadding) {
    document.documentElement.style.setProperty(
      '--aspect-ratio-padding',
      `${aspectRatioPadding}%`
    )
  }
</script>
