---
/**
 * MainLayout Component
 * 
 * Base layout template for all pages with responsive header/footer,
 * i18n support, and semantic HTML structure.
 * 
 * Requirements:
 * - 2.1: Multi-language support with i18n
 * - 9.1: Keyboard navigation and accessibility
 * - 9.4: Semantic HTML with ARIA landmarks
 */

import { $t, getCurrentLocale } from '@/lib/i18n'
import Header from '@/components/static/Header.astro'
import Footer from '@/components/static/Footer.astro'
import SkipNavigation from '@/components/static/SkipNavigation.astro'
import OfflineIndicator from '@/components/islands/OfflineIndicator'
import SyncStatusIndicator from '@/components/islands/SyncStatusIndicator'
import InstallPrompt from '@/components/islands/InstallPrompt'

// Import global styles including accessibility features
import '@/styles/global.css'

interface Props {
  /** Page title (will be appended to site title) */
  title?: string
  /** Page meta description */
  description?: string
  /** Hide navigation (for landing/onboarding pages) */
  hideNav?: boolean
  /** Current page path for active nav state */
  currentPath?: string
}

const { 
  title, 
  description, 
  hideNav = false,
  currentPath 
} = Astro.props

const locale = await getCurrentLocale()
const translations = await $t.get()

// Build full page title
const siteTitle = translations('common.app.title')
const fullTitle = title ? `${title} | ${siteTitle}` : siteTitle

// Default description
const defaultDescription = translations('common.app.tagline')
const metaDescription = description || defaultDescription

// Get user ID for preferences sync
const user = Astro.locals.user
const userId = user?.id
---

<!DOCTYPE html>
<html lang={locale} class="h-full">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content={metaDescription} />
    
    {/* Theme color for mobile browsers */}
    <meta name="theme-color" content="#3b82f6" />
    
    {/* Prevent zoom on input focus (iOS) while maintaining accessibility */}
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0" />
    
    <title>{fullTitle}</title>
    
    {/* Favicon and app icons */}
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    
    {/* PWA manifest */}
    <link rel="manifest" href="/manifest.json" />
    
    {/* Apple Touch Icon for iOS */}
    <link rel="apple-touch-icon" href="/icons/apple-touch-icon.png" />
    
    {/* iOS meta tags for standalone mode */}
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="default" />
    <meta name="apple-mobile-web-app-title" content="Matematik Ã˜velse" />
    
    {/* Windows tile configuration */}
    <meta name="msapplication-TileColor" content="#3b82f6" />
    <meta name="msapplication-TileImage" content="/icons/icon-144x144.png" />
    <meta name="msapplication-config" content="none" />
    
    {/* Preload critical resources */}
    <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin />

    {/* Apply preferences immediately to prevent flash of unstyled content */}
    <script is:inline>
      (function() {
        try {
          const stored = localStorage.getItem('math-preferences')
          if (!stored) return

          const prefs = JSON.parse(stored)
          const html = document.documentElement

          // Apply theme
          if (prefs.theme === 'dark') {
            html.classList.add('dark-theme')
          } else if (prefs.theme === 'system') {
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches
            if (prefersDark) html.classList.add('dark-theme')
          }

          // Apply font size
          if (prefs.fontSize) {
            html.classList.add('font-' + prefs.fontSize)
          }

          // Apply dyslexia font
          if (prefs.dyslexiaFont) {
            html.classList.add('dyslexia-font')
          }

          // Apply high contrast
          if (prefs.highContrast) {
            html.classList.add('high-contrast')
          }
        } catch (e) {
          // Silently fail - preferences will load normally
        }
      })()
    </script>

    {/* Service worker registration (production only) */}
    <script>
      if ('serviceWorker' in navigator && import.meta.env.PROD) {
        window.addEventListener('load', async () => {
          try {
            const registration = await navigator.serviceWorker.register('/sw.js', {
              scope: '/'
            });
            console.log('[SW] Service worker registered successfully');

            // Listen for updates
            registration.addEventListener('updatefound', () => {
              const newWorker = registration.installing;
              if (newWorker) {
                newWorker.addEventListener('statechange', () => {
                  if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                    console.log('[SW] New version available - refresh to update');
                    // Could show update notification here
                  }
                });
              }
            });
          } catch (error) {
            console.error('[SW] Registration failed:', error);
          }
        });
      } else if (import.meta.env.DEV) {
        console.log('[SW] Service worker disabled in development mode');
      }
    </script>

    {/* Preferences system initialization */}
    <script define:vars={{ userId }}>
      import { initializePreferencesSystem } from '@/lib/preferences'

      // Initialize preferences system after DOM is ready
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => {
          initializePreferencesSystem(userId)
        })
      } else {
        initializePreferencesSystem(userId)
      }
    </script>
  </head>
  
  <body class="h-full flex flex-col bg-gray-50 text-gray-900">
    {/* Skip navigation links - first for keyboard users */}
    <SkipNavigation />

    {/* Offline status indicator */}
    <OfflineIndicator client:load />

    {/* PWA install prompt */}
    <InstallPrompt client:idle />

    {/* Header with navigation */}
    {!hideNav && <Header currentPath={currentPath} />}
    
    {/* Main content area */}
    <main
      id="main-content"
      class="flex-1 w-full"
      role="main"
    >
      <slot />
    </main>
    
    {/* Footer */}
    {!hideNav && <Footer />}
    
    {/* Sync status indicator (floating) */}
    <SyncStatusIndicator client:idle />
    
    {/* Global styles and utilities */}
    <style is:global>
      /* CSS Reset and base styles */
      *, *::before, *::after {
        box-sizing: border-box;
      }
      
      html {
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
        text-rendering: optimizeLegibility;
      }
      
      body {
        margin: 0;
        padding: 0;
        min-height: 100vh;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', 
                     Roboto, 'Helvetica Neue', Arial, sans-serif;
        line-height: 1.5;
      }
      
      /* Focus visible styles for accessibility */
      *:focus-visible {
        outline: 2px solid #3b82f6;
        outline-offset: 2px;
      }
      
      /* Remove default focus for mouse users */
      *:focus:not(:focus-visible) {
        outline: none;
      }
      
      /* Smooth scrolling */
      html {
        scroll-behavior: smooth;
      }
      
      /* Reduce motion for users who prefer it */
      @media (prefers-reduced-motion: reduce) {
        *,
        *::before,
        *::after {
          animation-duration: 0.01ms !important;
          animation-iteration-count: 1 !important;
          transition-duration: 0.01ms !important;
          scroll-behavior: auto !important;
        }
      }
      
      /* Ensure minimum touch target size on mobile */
      @media (pointer: coarse) {
        button,
        a,
        input[type="button"],
        input[type="submit"],
        input[type="reset"] {
          min-width: 44px;
          min-height: 44px;
        }
      }
      
      /* Print styles */
      @media print {
        header,
        footer,
        nav,
        .no-print {
          display: none !important;
        }
        
        main {
          max-width: 100% !important;
          margin: 0 !important;
          padding: 0 !important;
        }
      }
      
      /* High contrast mode support */
      @media (prefers-contrast: high) {
        * {
          border-color: currentColor !important;
        }
      }
      
      /* Animation utilities */
      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }
      
      @keyframes ping {
        75%, 100% {
          transform: scale(2);
          opacity: 0;
        }
      }
      
      @keyframes pulse {
        0%, 100% {
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
      }
      
      .animate-spin {
        animation: spin 1s linear infinite;
      }
      
      .animate-ping {
        animation: ping 1s cubic-bezier(0, 0, 0.2, 1) infinite;
      }
      
      .animate-pulse {
        animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
      }
    </style>
  </body>
</html>

