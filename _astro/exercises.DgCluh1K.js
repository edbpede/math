import{p as e,c as t,a as n}from"./solid-core.DXeZPQOr.js";const s=[{locale:"da-DK",name:"Danish",nativeName:"Dansk",direction:"ltr",numberFormat:{decimalSeparator:",",thousandsSeparator:"."},dateFormat:{short:"dd/MM/yyyy",medium:"d. MMM yyyy",long:"d. MMMM yyyy"}},{locale:"en-US",name:"English",nativeName:"English",direction:"ltr",numberFormat:{decimalSeparator:".",thousandsSeparator:","},dateFormat:{short:"MM/dd/yyyy",medium:"MMM d, yyyy",long:"MMMM d, yyyy"}}],a={},r=function(e,t,n){let s=Promise.resolve();if(t&&t.length>0){let e=function(e){return Promise.all(e.map(e=>Promise.resolve(e).then(e=>({status:"fulfilled",value:e}),e=>({status:"rejected",reason:e}))))};document.getElementsByTagName("link");const n=document.querySelector("meta[property=csp-nonce]"),r=n?.nonce||n?.getAttribute("nonce");s=e(t.map(e=>{if((e=function(e){return"/"+e}(e))in a)return;a[e]=!0;const t=e.endsWith(".css"),n=t?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${e}"]${n}`))return;const s=document.createElement("link");return s.rel=t?"stylesheet":"modulepreload",t||(s.as="script"),s.crossOrigin="",s.href=e,r&&s.setAttribute("nonce",r),document.head.appendChild(s),t?new Promise((t,n)=>{s.addEventListener("load",t),s.addEventListener("error",()=>n(new Error(`Unable to preload CSS for ${e}`)))}):void 0}))}function r(e){const t=new Event("vite:preloadError",{cancelable:!0});if(t.payload=e,window.dispatchEvent(t),!t.defaultPrevented)throw e}return s.then(t=>{for(const e of t||[])"rejected"===e.status&&r(e.reason);return e().catch(r)})},o=(e,t,n)=>{const s=e[t];return s?"function"==typeof s?s():Promise.resolve(s):new Promise((e,s)=>{("function"==typeof queueMicrotask?queueMicrotask:setTimeout)(s.bind(null,new Error("Unknown variable dynamic import: "+t+(t.split("/").length!==n?". Note that variables only represent file names one level deep.":""))))})},i=new Map;async function c(e){if(i.has(e))return i.get(e);try{const[t,n,s,a,c,l,d,h,m]=await Promise.all([o(Object.assign({"../../locales/da-DK/common.json":()=>r(()=>import("./common.Deq5yspO.js"),[]),"../../locales/en-US/common.json":()=>r(()=>import("./common.DdIz3n71.js"),[])}),`../../locales/${e}/common.json`,5),o(Object.assign({"../../locales/da-DK/auth.json":()=>r(()=>import("./auth.HVp6IZyE.js"),[]),"../../locales/en-US/auth.json":()=>r(()=>import("./auth.Bs-kKy4E.js"),[])}),`../../locales/${e}/auth.json`,5),o(Object.assign({"../../locales/da-DK/navigation.json":()=>r(()=>import("./navigation.DaQgWJid.js"),[]),"../../locales/en-US/navigation.json":()=>r(()=>import("./navigation.BWyitVbv.js"),[])}),`../../locales/${e}/navigation.json`,5),o(Object.assign({"../../locales/da-DK/competencies.json":()=>r(()=>import("./competencies.DdIfjZOw.js"),[]),"../../locales/en-US/competencies.json":()=>r(()=>import("./competencies.D0vbV592.js"),[])}),`../../locales/${e}/competencies.json`,5),o(Object.assign({"../../locales/da-DK/exercises.json":()=>r(()=>import("./exercises.-HbE34H0.js"),[]),"../../locales/en-US/exercises.json":()=>r(()=>import("./exercises.f_a8eqX8.js"),[])}),`../../locales/${e}/exercises.json`,5),o(Object.assign({"../../locales/da-DK/feedback.json":()=>r(()=>import("./feedback.DdROBMVV.js"),[]),"../../locales/en-US/feedback.json":()=>r(()=>import("./feedback.B4KoD1rw.js"),[])}),`../../locales/${e}/feedback.json`,5),o(Object.assign({"../../locales/da-DK/hints.json":()=>r(()=>import("./hints.BlcneRBO.js"),[]),"../../locales/en-US/hints.json":()=>r(()=>import("./hints.BHbJ-Wfw.js"),[])}),`../../locales/${e}/hints.json`,5),o(Object.assign({"../../locales/da-DK/contexts.json":()=>r(()=>import("./contexts.B_-mASXS.js"),[]),"../../locales/en-US/contexts.json":()=>r(()=>import("./contexts.BADfajon.js"),[])}),`../../locales/${e}/contexts.json`,5),o(Object.assign({"../../locales/da-DK/errors.json":()=>r(()=>import("./errors.CgpIExeM.js"),[]),"../../locales/en-US/errors.json":()=>r(()=>import("./errors.DKgWLm6q.js"),[])}),`../../locales/${e}/errors.json`,5)]),u={common:t.default||t,auth:n.default||n,navigation:s.default||s,competencies:a.default||a,exercises:c.default||c,feedback:l.default||l,hints:d.default||d,contexts:h.default||h,errors:m.default||m};return i.set(e,u),u}catch(t){if("da-DK"!==e)return c("da-DK");throw new Error(`Failed to load Danish fallback translations: ${t}`)}}const l=e("app:locale",function(){if("undefined"==typeof window)return"da-DK";const e=navigator.language||navigator.userLanguage;return"da-DK"===e||"en-US"===e?e:e.startsWith("da")?"da-DK":e.startsWith("en")?"en-US":"da-DK"}(),{encode:JSON.stringify,decode:JSON.parse}),d=n(null),h=n(!1);async function m(e){if(l.get()!==e){h.set(!0);try{const t=await c(e);l.set(e),d.set(t)}catch(t){}finally{h.set(!1)}}}const u=t([d,l],(e,t)=>(t,n)=>{if(!e)return t;const s=t.split("."),a=s[0],r=s.slice(1).join(".");if(!(a in e))return t;const o=function(e,t){const n=t.split(".");let s=e;for(const a of n){if(!s||"object"!=typeof s||!(a in s))return;s=s[a]}return s}(e[a],r);return"string"!=typeof o?t:function(e,t){return t?e.replace(/\{\{(\w+)\}\}/g,(e,n)=>n in t?String(t[n]):e):e}(o,n)});function f(e,t){const n=t?.locale||l.get(),a=t?.decimals??2,r=t?.useGrouping??!0,o=function(e){const t=s.find(t=>t.locale===e);return t||s[0]}(n),i=e.toFixed(a).split(".");let c=i[0];const d=i[1];return r&&c.length>3&&(c=c.replace(/\B(?=(\d{3})+(?!\d))/g,o.numberFormat.thousandsSeparator)),a>0&&d?`${c}${o.numberFormat.decimalSeparator}${d}`:c}class g{cache;maxSize;constructor(e){this.cache=new Map,this.maxSize=e}get(e){const t=this.cache.get(e);return void 0!==t&&(this.cache.delete(e),this.cache.set(e,t)),t}set(e,t){if(this.cache.has(e)&&this.cache.delete(e),this.cache.set(e,t),this.cache.size>this.maxSize){const e=this.cache.keys().next().value;void 0!==e&&this.cache.delete(e)}}has(e){return this.cache.has(e)}clear(){this.cache.clear()}get size(){return this.cache.size}}function p(e,t={}){const{maxSize:n=100,keySerializer:s=e=>JSON.stringify(e)}=t,a=new g(n),r=function(...t){const n=s(t);if(a.has(n))return a.get(n);const r=e.apply(this,t);return a.set(n,r),r};return r.cache={clear:()=>a.clear(),size:()=>a.size},r}const x=function(e,t={}){const{maxSize:n=100,keySerializer:s=e=>JSON.stringify(e)}=t,a=new g(n),r=function(...t){const n=s(t);if(a.has(n))return a.get(n);const r=e.apply(this,t);return a.set(n,r),r.catch(()=>{}),r};return r.cache={clear:()=>a.clear(),size:()=>a.size},r}(async function(e){const t=e||l.get();try{const e=await o(Object.assign({"../../locales/da-DK/contexts.json":()=>r(()=>import("./contexts.B_-mASXS.js"),[]),"../../locales/en-US/contexts.json":()=>r(()=>import("./contexts.BADfajon.js"),[])}),`../../locales/${t}/contexts.json`,5),n=e.default||e;return{locale:t,names:n.names?.male.concat(n.names?.female||[]).concat(n.names?.neutral||[])||[],places:n.places?.cities.concat(n.places?.locations||[])||[],currency:n.currency||{symbol:"kr",name:"kroner"},items:n.items||{}}}catch(n){return{locale:t,names:[],places:[],currency:{symbol:"kr",name:"kroner"},items:{}}}},{maxSize:10});class y{locale;contextPool=null;usageTrackers=new Map;defaultMaxRecent;constructor(e,t=10){this.locale=e,this.defaultMaxRecent=t}async loadContextPool(){this.contextPool=await x(this.locale)}getTracker(e){return this.usageTrackers.has(e)||this.usageTrackers.set(e,{category:e,recentlyUsed:[],maxRecentSize:this.defaultMaxRecent}),this.usageTrackers.get(e)}markAsUsed(e,t){const n=this.getTracker(e),s=n.recentlyUsed.indexOf(t);s>-1&&n.recentlyUsed.splice(s,1),n.recentlyUsed.unshift(t),n.recentlyUsed.length>n.maxRecentSize&&(n.recentlyUsed=n.recentlyUsed.slice(0,n.maxRecentSize))}getAvailableItems(e,t){const n=this.getTracker(e),s=t.filter(e=>!n.recentlyUsed.includes(e));return 0===s.length?(n.recentlyUsed=[],t):s}async selectName(e){if(this.contextPool||await this.loadContextPool(),!this.contextPool)throw new Error("Failed to load context pool");const t=await o(Object.assign({"../../locales/da-DK/contexts.json":()=>r(()=>import("./contexts.B_-mASXS.js"),[]),"../../locales/en-US/contexts.json":()=>r(()=>import("./contexts.BADfajon.js"),[])}),`../../locales/${this.locale}/contexts.json`,5),n=t.default||t;let s=[],a="names";if(e?(s=n.names?.[e]||[],a=`names:${e}`):s=[...n.names?.male||[],...n.names?.female||[],...n.names?.neutral||[]],0===s.length)throw new Error(`No names available for gender: ${e||"any"}`);const i=this.getAvailableItems(a,s),c=i[Math.floor(Math.random()*i.length)];return this.markAsUsed(a,c),c}async selectNames(e=1,t){const n=[];for(let s=0;s<e;s++)n.push(await this.selectName(t));return n}async selectPlace(e){if(this.contextPool||await this.loadContextPool(),!this.contextPool)throw new Error("Failed to load context pool");const t=await o(Object.assign({"../../locales/da-DK/contexts.json":()=>r(()=>import("./contexts.B_-mASXS.js"),[]),"../../locales/en-US/contexts.json":()=>r(()=>import("./contexts.BADfajon.js"),[])}),`../../locales/${this.locale}/contexts.json`,5),n=t.default||t;let s=[],a="places";if(e?(s=n.places?.[e]||[],a=`places:${e}`):s=[...n.places?.cities||[],...n.places?.locations||[],...n.places?.neighborhoods||[]],0===s.length)throw new Error(`No places available for type: ${e||"any"}`);const i=this.getAvailableItems(a,s),c=i[Math.floor(Math.random()*i.length)];return this.markAsUsed(a,c),c}async selectItems(e,t=1){if(this.contextPool||await this.loadContextPool(),!this.contextPool)throw new Error("Failed to load context pool");const n=await o(Object.assign({"../../locales/da-DK/contexts.json":()=>r(()=>import("./contexts.B_-mASXS.js"),[]),"../../locales/en-US/contexts.json":()=>r(()=>import("./contexts.BADfajon.js"),[])}),`../../locales/${this.locale}/contexts.json`,5),s=n.default||n,a=s.items?.[e]||[];if(0===a.length)throw new Error(`No items available for category: ${e}`);const i=`items:${e}`,c=[...this.getAvailableItems(i,a)].sort(()=>Math.random()-.5),l=c.slice(0,Math.min(t,c.length));return l.forEach(e=>this.markAsUsed(i,e)),l}async selectScenario(e){if(this.contextPool||await this.loadContextPool(),!this.contextPool)throw new Error("Failed to load context pool");const t=await o(Object.assign({"../../locales/da-DK/contexts.json":()=>r(()=>import("./contexts.B_-mASXS.js"),[]),"../../locales/en-US/contexts.json":()=>r(()=>import("./contexts.BADfajon.js"),[])}),`../../locales/${this.locale}/contexts.json`,5),n=t.default||t,s=n.scenarios?.[e]||[];if(0===s.length)throw new Error(`No scenarios available for category: ${e}`);const a=`scenarios:${e}`,i=this.getAvailableItems(a,s),c=i[Math.floor(Math.random()*i.length)];return this.markAsUsed(a,c),c}async selectActivityVerb(){if(this.contextPool||await this.loadContextPool(),!this.contextPool)throw new Error("Failed to load context pool");const e=await o(Object.assign({"../../locales/da-DK/contexts.json":()=>r(()=>import("./contexts.B_-mASXS.js"),[]),"../../locales/en-US/contexts.json":()=>r(()=>import("./contexts.BADfajon.js"),[])}),`../../locales/${this.locale}/contexts.json`,5),t=e.default||e,n=t.activities?.verbs||[];if(0===n.length)throw new Error("No activity verbs available");const s="activities:verbs",a=this.getAvailableItems(s,n),i=a[Math.floor(Math.random()*a.length)];return this.markAsUsed(s,i),i}getCurrency(){if(!this.contextPool)throw new Error("Context pool not loaded. Call loadContextPool() first.");return this.contextPool.currency}resetUsageTracking(){this.usageTrackers.clear()}resetCategoryTracking(e){this.usageTrackers.delete(e)}getUsageStats(){const e={};for(const[t,n]of this.usageTrackers.entries())e[t]={total:n.recentlyUsed.length,available:n.maxRecentSize-n.recentlyUsed.length};return e}}class w extends Error{constructor(e,t,n){super(`Parameter generation failed for '${t}': ${e}`),this.parameterName=t,this.cause=n,this.name="ParameterGenerationError"}}class _ extends Error{constructor(e,t,n){super(`Constraint violation for '${t}' (value: ${n}): ${e}`),this.parameterName=t,this.value=n,this.name="ConstraintViolationError"}}const I={maxAttempts:100,seed:Date.now()};class v{state;constructor(e){this.state=e>>>0||1}next(){let e=this.state+=1831565813;return e=Math.imul(e^e>>>15,1|e),e^=e+Math.imul(e^e>>>7,61|e),((e^e>>>14)>>>0)/4294967296}nextInt(e,t){if(!Number.isInteger(e)||!Number.isInteger(t))throw new Error("nextInt requires integer bounds");if(e>t)throw new Error("min must be less than or equal to max");return Math.floor(this.next()*(t-e+1))+e}nextFloat(e,t){if(e>=t)throw new Error("min must be less than max");return this.next()*(t-e)+e}choice(e){if(0===e.length)throw new Error("Cannot select from empty array");return e[Math.floor(this.next()*e.length)]}shuffle(e){const t=[...e];for(let n=t.length-1;n>0;n--){const e=Math.floor(this.next()*(n+1));[t[n],t[e]]=[t[e],t[n]]}return t}}class E{rng;config;constructor(e={}){this.config={...I,...e},this.rng=new v(this.config.seed)}generate(e){const t=this.computeGenerationOrder(e);for(let s=0;s<this.config.maxAttempts;s++)try{const n={};for(const s of t){const t=e[s],a=this.generateParameter(s,t,n);n[s]=a}return this.validateParameters(n,e),n}catch(n){if(s===this.config.maxAttempts-1){if(n instanceof _)throw new w(`Failed to generate valid parameters after ${this.config.maxAttempts} attempts`,n.parameterName,n);throw n}continue}throw new w(`Failed to generate parameters after ${this.config.maxAttempts} attempts`,"unknown")}validate(e,t,n,s={}){if(!this.validateType(t,n.type))throw new _(`Expected type ${n.type} but got ${typeof t}`,e,t);if("integer"===n.type||"decimal"===n.type){const s=t;if(void 0!==n.min&&s<n.min)throw new _(`Value ${s} is less than minimum ${n.min}`,e,t);if(void 0!==n.max&&s>n.max)throw new _(`Value ${s} is greater than maximum ${n.max}`,e,t);if(void 0!==n.step&&void 0!==n.min){const a=(s-n.min)/n.step;if(!Number.isInteger(a))throw new _(`Value ${s} does not match step ${n.step} from minimum ${n.min}`,e,t)}}if(n.options&&n.options.length>0&&!n.options.includes(t))throw new _(`Value is not in allowed options: ${JSON.stringify(n.options)}`,e,t);if(n.constraint){const a={...s,[e]:t};if(!n.constraint(a))throw new _("Custom constraint function returned false",e,t)}}getRNG(){return this.rng}resetSeed(e){this.rng=new v(e),this.config.seed=e}generateParameter(e,t,n){try{if(t.options&&t.options.length>0)return this.rng.choice(t.options);switch(t.type){case"integer":return this.generateInteger(t);case"decimal":return this.generateDecimal(t);case"fraction":return this.generateFraction(t);case"string":return this.generateString(t);default:throw new w(`Unknown parameter type: ${t.type}`,e)}}catch(s){if(s instanceof w)throw s;throw new w(`Failed to generate parameter: ${s instanceof Error?s.message:String(s)}`,e,s)}}generateInteger(e){const t=e.min??0,n=e.max??100,s=e.step??1,a=Math.floor((n-t)/s);return t+this.rng.nextInt(0,a)*s}generateDecimal(e){const t=e.min??0,n=e.max??100,s=e.step;if(void 0!==s){const e=Math.floor((n-t)/s),a=this.rng.nextInt(0,e);return Number((t+a*s).toFixed(10))}return Number(this.rng.nextFloat(t,n).toFixed(2))}generateFraction(e){const t=e.min??1,n=e.max??10,s=this.rng.nextInt(t,n),a=this.rng.nextInt(t,n);return`${s}/${0===a?1:a}`}generateString(e){if(!e.options||0===e.options.length)throw new Error("String parameters must have options defined");return this.rng.choice(e.options)}validateType(e,t){switch(t){case"integer":return"number"==typeof e&&Number.isInteger(e);case"decimal":return"number"==typeof e;case"fraction":return"string"==typeof e&&/^\d+\/\d+$/.test(e);case"string":return"string"==typeof e;default:return!1}}computeGenerationOrder(e){const t=Object.keys(e),n=new Set,s=new Set,a=[],r=t=>{if(n.has(t))return;if(s.has(t))throw new w("Circular dependency detected",t);s.add(t);const o=e[t];if(o.dependsOn)for(const n of o.dependsOn){if(!e[n])throw new w(`Depends on undefined parameter: ${n}`,t);r(n)}s.delete(t),n.add(t),a.push(t)};for(const o of t)r(o);return a}validateParameters(e,t){for(const[n,s]of Object.entries(t)){const t=e[n];this.validate(n,t,s,e)}}}const j={srsBaseline:1,bindingBonus:.3,recencyPenalty:.5,masteryAdjustment:0};class b extends Error{constructor(e,t,n){super(`Template validation failed for '${t}': ${e}`),this.templateId=t,this.field=n,this.name="TemplateValidationError"}}const S=new class{templates=new Map;competencyIndex=new Map;skillsIndex=new Map;gradeIndex=new Map;difficultyIndex=new Map;bindingIndex=new Map;tagIndex=new Map;recentlyUsed=[];maxRecentSize=20;register(e){if(this.validateTemplate(e),this.templates.has(e.id))throw new b("Template ID already registered",e.id,"id");const t={template:e,weight:1,lastUsed:void 0,usageCount:0};this.templates.set(e.id,t),this.indexTemplate(e.id,e.metadata)}unregister(e){const t=this.templates.get(e);return!!t&&(this.deindexTemplate(e,t.template.metadata),this.templates.delete(e),this.recentlyUsed=this.recentlyUsed.filter(t=>t!==e),!0)}get(e){return this.templates.get(e)?.template}has(e){return this.templates.has(e)}count(){return this.templates.size}find(e){let t=new Set(this.templates.keys());return void 0!==e.competencyAreaId&&(t=this.intersect(t,this.competencyIndex.get(e.competencyAreaId))),void 0!==e.skillsAreaId&&(t=this.intersect(t,this.skillsIndex.get(e.skillsAreaId))),void 0!==e.gradeRange&&(t=this.intersect(t,this.gradeIndex.get(e.gradeRange))),void 0!==e.difficulty&&(t=this.intersect(t,this.difficultyIndex.get(e.difficulty))),void 0!==e.isBinding&&(t=this.intersect(t,this.bindingIndex.get(e.isBinding))),e.tags&&e.tags.length>0&&(t=new Set(Array.from(t).filter(t=>{const n=this.templates.get(t);return!!n&&e.tags.every(e=>n.template.metadata.tags.includes(e))}))),e.excludeTemplateIds&&e.excludeTemplateIds.length>0&&e.excludeTemplateIds.forEach(e=>t.delete(e)),Array.from(t)}select(e,t={},n=50){const s=this.find(e);if(0===s.length)return;if(1===s.length)return s[0];const a={...j,...t},r=s.map(e=>({id:e,weight:this.calculateWeight(e,a,n)}));return this.weightedRandomSelect(r)}markUsed(e){const t=this.templates.get(e);t&&(t.lastUsed=new Date,t.usageCount+=1,this.recentlyUsed.push(e),this.recentlyUsed.length>this.maxRecentSize&&this.recentlyUsed.shift())}getRecentlyUsed(){return[...this.recentlyUsed].reverse()}clearRecentlyUsed(){this.recentlyUsed=[]}getUsageStats(e){const t=this.templates.get(e);if(t)return{usageCount:t.usageCount,lastUsed:t.lastUsed}}validateTemplate(e){if(!e.id||"string"!=typeof e.id||""===e.id.trim())throw new b("Template ID is required and must be a non-empty string",e.id||"unknown","id");if(!e.name||"string"!=typeof e.name||""===e.name.trim())throw new b("Template name is required and must be a non-empty string",e.id,"name");if(!e.metadata)throw new b("Template metadata is required",e.id,"metadata");if(this.validateMetadata(e.id,e.metadata),!e.parameters||"object"!=typeof e.parameters)throw new b("Template parameters must be an object",e.id,"parameters");if("function"!=typeof e.generate)throw new b("Template generate must be a function",e.id,"generate");if("function"!=typeof e.validate)throw new b("Template validate must be a function",e.id,"validate");if(!Array.isArray(e.hints))throw new b("Template hints must be an array",e.id,"hints");if(e.hints.length<4)throw new b("Template must provide at least 4 hint levels",e.id,"hints");e.hints.forEach((t,n)=>{if("function"!=typeof t)throw new b(`Hint at index ${n} must be a function`,e.id,`hints[${n}]`)})}validateMetadata(e,t){if(!["matematiske-kompetencer","tal-og-algebra","geometri-og-maling","statistik-og-sandsynlighed"].includes(t.competencyAreaId))throw new b(`Invalid competency area ID: ${t.competencyAreaId}`,e,"metadata.competencyAreaId");if(!t.skillsAreaId||"string"!=typeof t.skillsAreaId)throw new b("Skills area ID is required and must be a string",e,"metadata.skillsAreaId");if(!["0-3","4-6","7-9"].includes(t.gradeRange))throw new b(`Invalid grade range: ${t.gradeRange}`,e,"metadata.gradeRange");if(!["A","B","C"].includes(t.difficulty))throw new b(`Invalid difficulty: ${t.difficulty}`,e,"metadata.difficulty");if("boolean"!=typeof t.isBinding)throw new b("isBinding must be a boolean",e,"metadata.isBinding");if(!Array.isArray(t.tags))throw new b("Tags must be an array",e,"metadata.tags");t.tags.forEach((t,n)=>{if("string"!=typeof t)throw new b(`Tag at index ${n} must be a string`,e,`metadata.tags[${n}]`)})}indexTemplate(e,t){this.addToIndex(this.competencyIndex,t.competencyAreaId,e),this.addToIndex(this.skillsIndex,t.skillsAreaId,e),this.addToIndex(this.gradeIndex,t.gradeRange,e),this.addToIndex(this.difficultyIndex,t.difficulty,e),this.addToIndex(this.bindingIndex,t.isBinding,e),t.tags.forEach(t=>{this.addToIndex(this.tagIndex,t,e)})}deindexTemplate(e,t){this.removeFromIndex(this.competencyIndex,t.competencyAreaId,e),this.removeFromIndex(this.skillsIndex,t.skillsAreaId,e),this.removeFromIndex(this.gradeIndex,t.gradeRange,e),this.removeFromIndex(this.difficultyIndex,t.difficulty,e),this.removeFromIndex(this.bindingIndex,t.isBinding,e),t.tags.forEach(t=>{this.removeFromIndex(this.tagIndex,t,e)})}addToIndex(e,t,n){let s=e.get(t);s||(s=new Set,e.set(t,s)),s.add(n)}removeFromIndex(e,t,n){const s=e.get(t);s&&(s.delete(n),0===s.size&&e.delete(t))}intersect(e,t){return t?new Set(Array.from(e).filter(e=>t.has(e))):new Set}calculateWeight(e,t,n){const s=this.templates.get(e);if(!s)return 0;let a=t.srsBaseline;s.template.metadata.isBinding&&(a+=t.bindingBonus);const r=this.recentlyUsed.indexOf(e);if(-1!==r){const e=(this.recentlyUsed.length-r)/this.recentlyUsed.length;a-=t.recencyPenalty*e}const o={A:1,B:2,C:3}[s.template.metadata.difficulty],i=1+n/50,c=Math.abs(o-i);return a-=t.masteryAdjustment*c,Math.max(0,a)}weightedRandomSelect(e){const t=e.reduce((e,t)=>e+t.weight,0);if(t<=0)return e[Math.floor(Math.random()*e.length)].id;let n=Math.random()*t;for(const s of e)if(n-=s.weight,n<=0)return s.id;return e[e.length-1].id}};function A(e,t,n){switch(t){case"off-by-one":return function(e,t){return e+(t.next()<.5?1:-1)}(e,n);case"wrong-operation":return function(e,t){const n=t.nextInt(2,5);return t.next()<.5?e*n:Math.floor(e/n)}(e,n);case"sign-error":return-e;case"place-value":return function(e,t){const n=t.next()<.5?10:.1;return e*n}(e,n);case"factor-multiple":return function(e,t){if(e<=1)return 2*e;const n=[2,3,4,5],s=t.choice(n);return t.next()<.5?e*s:Math.floor(e/s)}(e,n);case"common-mistake":return function(e,t){const n=[()=>10*Math.floor(e/10),()=>100*Math.floor(e/100),()=>e+Math.floor(.1*e),()=>e-Math.floor(.1*e)];return t.choice(n)()}(e,n);default:return e+n.nextInt(-5,5)}}function $(e,t={}){const n=e.value;return"number"==typeof n?function(e,t={}){const{count:n=3,strategies:s,seed:a=Date.now(),excludeValues:r=[]}=t,o=new v(a),i=new Set,c="number"==typeof e.value?e.value:parseFloat(e.value.toString()),l=new Set([e.value.toString(),...r.map(e=>e.toString())]);e.equivalents&&e.equivalents.forEach(e=>l.add(e.toString()));const d=s||["off-by-one","wrong-operation","sign-error","place-value","factor-multiple"];let h=0;const m=10*n;for(;i.size<n&&h<m;){h++;const e=A(c,o.choice(d),o).toString();l.has(e)||i.has(e)||i.add(e)}for(;i.size<n&&h<m;){h++;const e=o.nextInt(-10,10);if(0===e)continue;const t=(c+e).toString();l.has(t)||i.has(t)||i.add(t)}return Array.from(i)}(e,t):"string"==typeof n?n.match(/^\d+\/\d+$/)?function(e,t={}){const{count:n=3,seed:s=Date.now(),excludeValues:a=[]}=t,r=new v(s),o=new Set,i=e.value.toString().match(/^(\d+)\/(\d+)$/);if(!i)return[];const[,c,l]=i,d=parseInt(c,10),h=parseInt(l,10),m=new Set([e.value.toString(),...a.map(e=>e.toString())]);e.equivalents&&e.equivalents.forEach(e=>m.add(e.toString()));const u=[()=>`${h}/${d}`,()=>`${d+1}/${h}`,()=>`${d-1}/${h}`,()=>`${d}/${h+1}`,()=>`${d}/${h-1}`,()=>{const e=r.nextInt(2,4);return`${d*e}/${h*e+1}`},()=>{const e=r.nextInt(2,3);return`${Math.floor(d/e)}/${Math.floor(h/e)}`}];let f=0;const g=10*n;for(;o.size<n&&f<g;){f++;const e=r.choice(u)();!e.match(/^\d+\/\d+$/)||m.has(e)||o.has(e)||o.add(e)}return Array.from(o)}(e,t):function(e,t={}){const{count:n=3,seed:s=Date.now(),excludeValues:a=[],alternatives:r=[]}=t,o=new v(s),i=new Set,c=new Set([e.value.toString(),...a.map(e=>e.toString())]);if(e.equivalents&&e.equivalents.forEach(e=>c.add(e.toString())),r.length>0){const e=o.shuffle(r);for(const t of e){if(i.size>=n)break;c.has(t)||i.add(t)}}return Array.from(i)}(e,t):[]}class T extends Error{constructor(e,t,n,s){super(`Instance generation failed for template '${t}' with seed ${n}: ${e}`),this.templateId=t,this.seed=n,this.cause=s,this.name="InstanceGenerationError"}}async function D(e,t,n={}){const{locale:s="da-DK",contextSelector:a,includeDistractors:r=!0,distractorCount:o=3}=n,i=S.get(e);if(!i)throw new T("Template not found in registry",e,t);try{const n=new E({seed:t}).generate(i.parameters),l=a||new y(s),d={locale:s,contextType:i.contextType};if(i.contextType&&"abstract"!==i.contextType)try{d.names=await l.selectNames(2),d.places=[await l.selectPlace()];const e={shopping:"food",school:"school",nature:"animals",sports:"sports"}[i.contextType];e&&(d.items=await l.selectItems(e,3))}catch(c){}const h=i.generate(n,s),m=function(e,t,n,s){let a=e;s.names&&s.names.length>0&&(s.names.forEach((e,t)=>{a=a.replace(new RegExp(`\\{\\{context\\.names\\[${t}\\]\\}\\}`,"g"),e)}),a=a.replace(/\{\{context\.name\}\}/g,s.names[0]));if(s.places){const e=Array.isArray(s.places)?s.places[0]:s.places;a=a.replace(/\{\{context\.place\}\}/g,e)}s.items&&s.items.length>0&&(s.items.forEach((e,t)=>{a=a.replace(new RegExp(`\\{\\{context\\.items\\[${t}\\]\\}\\}`,"g"),e)}),a=a.replace(/\{\{context\.item\}\}/g,s.items[0]));const r=/\{\{([^:}]+)(?::([^}]+))?\}\}/g;return a=a.replace(r,(e,s,a)=>{const r=t[s];return void 0===r?e:"number"===a&&"number"==typeof r?f(r,{locale:n}):String(r)}),a}(h.questionText,n,s,d),u=i.hints.map((e,t)=>{const a=e(n,s);return"string"==typeof a?{level:t+1,text:a,visualAid:h.visualAid}:{level:t+1,...a}});let g;r&&(g=$(h.correctAnswer,{count:o,seed:t,excludeValues:[]}));const p=`${e}-${t}`;return S.markUsed(e),{id:p,templateId:e,questionText:m,correctAnswer:h.correctAnswer,distractors:g,hints:u,metadata:i.metadata,context:d,seed:t}}catch(c){throw new T(c instanceof Error?c.message:String(c),e,t,c)}}async function P(e,t,n={}){const{startSeed:s=Date.now(),locale:a="da-DK",contextSelector:r,includeDistractors:o=!0,distractorCount:i=3}=n,c=new Array(t),l=r||new y(a);for(let d=0;d<t;d++){const t=S.select(e);if(!t)throw new T("No templates found matching criteria","unknown",s+d);const n=s+d,r=await D(t,n,{locale:a,contextSelector:l,includeDistractors:o,distractorCount:i});c[d]=r}return c}function k(e,t){return{revealNext(){let n=null;return t(t=>t>=e.length?t:(n=e[t],t+1)),n},reset(){t(0)},getRevealedHints:t=>e.slice(0,t),areAllRevealed:t=>t>=e.length}}export{u as $,l as a,m as b,k as c,P as g,p as m};
