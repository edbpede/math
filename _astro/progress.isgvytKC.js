import{s as c}from"./client.D0X2hLWc.js";class p extends Error{constructor(s,t,a){super(s),this.operation=t,this.cause=a,this.name="ProgressError"}}const y={maxAttempts:3,initialDelayMs:100,maxDelayMs:2e3,backoffMultiplier:2};async function o(e,s,t=y){let a,n=t.initialDelayMs;for(let i=1;i<=t.maxAttempts;i++)try{return await e()}catch(r){if(a=r,i===t.maxAttempts)break;console.warn(`[ProgressTracking] ${s} failed (attempt ${i}/${t.maxAttempts}), retrying in ${n}ms`,r),await new Promise(m=>setTimeout(m,n)),n=Math.min(n*t.backoffMultiplier,t.maxDelayMs)}throw new p(`Failed to ${s} after ${t.maxAttempts} attempts`,s,a)}function d(e){return{competencyAreaId:e.competency_area_id,gradeRange:e.grade_range,masteryLevel:e.mastery_level,totalAttempts:e.total_attempts,successRate:Number(e.success_rate),lastPracticed:e.last_practiced_at?new Date(e.last_practiced_at):new Date,achievedAt:e.achieved_at?new Date(e.achieved_at):void 0}}function l(e){return{skillId:e.skill_id,masteryLevel:e.mastery_level,srsParams:{easeFactor:Number(e.ease_factor),interval:e.interval_days,repetitionCount:e.repetition_count},attempts:e.attempts,successes:e.successes,avgResponseTime:e.avg_response_time_ms??0,lastPracticed:e.last_practiced_at?new Date(e.last_practiced_at):new Date,nextReview:e.next_review_at?new Date(e.next_review_at):new Date}}function u(e){return{id:e.id,userId:e.user_id,sessionId:e.session_id,templateId:e.template_id,competencyAreaId:e.competency_area_id,skillId:e.skill_id,difficulty:e.difficulty,isBinding:e.is_binding,correct:e.correct,timeSpentSeconds:e.time_spent_seconds,hintsUsed:e.hints_used,userAnswer:e.user_answer??"",createdAt:new Date(e.created_at)}}function _(e){return{id:e.id,userId:e.user_id,gradeRange:e.grade_range,competencyAreaId:e.competency_area_id,startedAt:new Date(e.started_at),endedAt:e.ended_at?new Date(e.ended_at):void 0,totalExercises:e.total_exercises,correctCount:e.correct_count,avgTimePerExerciseSeconds:e.avg_time_per_exercise_seconds??void 0}}async function g(e){return o(async()=>{const{data:s,error:t}=await c.from("competency_progress").select("*").eq("user_id",e).order("competency_area_id",{ascending:!0});if(t)throw t;return(s??[]).map(d)},"fetch competency progress")}async function h(e,s,t){return o(async()=>{const{data:a,error:n}=await c.from("competency_progress").select("*").eq("user_id",e).eq("competency_area_id",s).eq("grade_range",t).single();if(n){if(n.code==="PGRST116")return null;throw n}return a?d(a):null},"fetch competency progress by area")}async function v(e){return o(async()=>{const{data:s,error:t}=await c.from("skills_progress").select("*").eq("user_id",e).order("skill_id",{ascending:!0});if(t)throw t;return(s??[]).map(l)},"fetch skills progress")}async function x(e,s){return o(async()=>{const{data:t,error:a}=await c.from("skills_progress").select("*").eq("user_id",e).eq("skill_id",s).single();if(a){if(a.code==="PGRST116")return null;throw a}return t?l(t):null},"fetch skill progress by skill")}async function k(e,s=100){return o(async()=>{const{data:t,error:a}=await c.from("exercise_history").select("*").eq("user_id",e).order("created_at",{ascending:!1}).limit(s);if(a)throw a;return(t??[]).map(u)},"fetch exercise history")}async function S(e,s){return s.length===0?[]:o(async()=>{const t=new Date().toISOString(),a=s.map(r=>({user_id:e,competency_area_id:r.competencyAreaId,grade_range:r.gradeRange,mastery_level:r.masteryLevel,total_attempts:r.totalAttempts,success_rate:r.successRate,last_practiced_at:t,achieved_at:r.masteryLevel>=80?t:void 0})),{data:n,error:i}=await c.from("competency_progress").upsert(a,{onConflict:"user_id,competency_area_id,grade_range"}).select();if(i)throw i;return(n??[]).map(d)},"batch update competency progress")}async function D(e,s){return s.length===0?[]:o(async()=>{const t=new Date().toISOString(),a=s.map(r=>({user_id:e,skill_id:r.skillId,mastery_level:r.masteryLevel,attempts:r.attempts,successes:r.successes,avg_response_time_ms:r.avgResponseTime,ease_factor:r.srsParams.easeFactor,interval_days:r.srsParams.interval,repetition_count:r.srsParams.repetitionCount,last_practiced_at:t,next_review_at:r.nextReview.toISOString()})),{data:n,error:i}=await c.from("skills_progress").upsert(a,{onConflict:"user_id,skill_id"}).select();if(i)throw i;return(n??[]).map(l)},"batch update skill progress")}async function A(e){return o(async()=>{const s={user_id:e.userId,session_id:e.sessionId,template_id:e.templateId,competency_area_id:e.competencyAreaId,skill_id:e.skillId,difficulty:e.difficulty,is_binding:e.isBinding,correct:e.correct,time_spent_seconds:e.timeSpentSeconds,hints_used:e.hintsUsed,user_answer:e.userAnswer},{data:t,error:a}=await c.from("exercise_history").insert(s).select().single();if(a)throw a;return u(t)},"log exercise attempt")}async function I(e,s,t){return o(async()=>{const a={user_id:e,grade_range:s,competency_area_id:t,started_at:new Date().toISOString()},{data:n,error:i}=await c.from("sessions").insert(a).select().single();if(i)throw i;return _(n)},"start session")}async function P(e,s,t){return o(async()=>{const a={total_exercises:s,correct_count:t},{data:n,error:i}=await c.from("sessions").update(a).eq("id",e).select().single();if(i)throw i;return _(n)},"update session")}async function w(e,s,t,a){return o(async()=>{const n={ended_at:new Date().toISOString(),total_exercises:s,correct_count:t,avg_time_per_exercise_seconds:Math.round(a)},{data:i,error:r}=await c.from("sessions").update(n).eq("id",e).select().single();if(r)throw r;return _(i)},"end session")}export{v as a,k as b,h as c,S as d,w as e,g as f,x as g,D as h,A as l,I as s,P as u};
