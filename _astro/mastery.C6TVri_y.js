import{m as e}from"./exercises.DgCluh1K.js";import{s as t}from"./island-dashboard.bEGyKmZ3.js";const n=[{level:"introduced",min:0,max:20,colorCode:"red"},{level:"developing",min:21,max:40,colorCode:"yellow"},{level:"progressing",min:41,max:60,colorCode:"light-green"},{level:"proficient",min:61,max:80,colorCode:"green"},{level:"mastered",min:81,max:100,colorCode:"blue"}],r=.45,a=.2,i=.15,o=.1,s=.1,c=5,u=20,l=14,f=10,d={"0-3":{A:{min:15,expected:30,max:60},B:{min:20,expected:45,max:90},C:{min:30,expected:60,max:120}},"4-6":{A:{min:20,expected:40,max:80},B:{min:30,expected:60,max:120},C:{min:45,expected:90,max:180}},"7-9":{A:{min:30,expected:60,max:120},B:{min:45,expected:90,max:180},C:{min:60,expected:120,max:240}}};function m(e){return e.includes("0-3")?"0-3":e.includes("4-6")?"4-6":e.includes("7-9")?"7-9":"0-3"}function g(e){const t=Math.max(0,Math.min(100,e));for(const r of n)if(t>=r.min&&t<=r.max)return r;return n[0]}function h(e){if(0===e.length)return{currentStreak:0,longestStreak:0,lastPracticeDate:null,isAtRisk:!0};const t=new Set;let n=null;for(const s of e){const e=s.createdAt,r=p(e);t.add(r),(!n||e>n)&&(n=e)}const r=Array.from(t).sort().reverse(),a=function(e){if(0===e.length)return 0;const t=p(new Date),n=p(function(){const e=new Date;return e.setDate(e.getDate()-1),e}());if(e[0]!==t&&e[0]!==n)return 0;let r=0,a=e[0];for(const i of e){if(i!==a)break;r++,a=x(a)}return r}(r),i=function(e){if(0===e.length)return 0;let t=1,n=1;for(let r=0;r<e.length-1;r++){const a=e[r];e[r+1]===x(a)?(n++,t=Math.max(t,n)):n=1}return t}(r),o=p(new Date);return{currentStreak:a,longestStreak:i,lastPracticeDate:n,isAtRisk:r[0]!==o}}function p(e){return`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}-${String(e.getDate()).padStart(2,"0")}`}function x(e){const t=new Date(e+"T00:00:00");return t.setDate(t.getDate()-1),p(t)}async function y(e,n=10){const{data:r,error:a}=await t.from("skills_progress").select("*").eq("user_id",e).not("next_review_at","is",null).order("next_review_at",{ascending:!0}).limit(2*n);if(a)return{overdue:[],today:[],thisWeek:[],upcoming:[],total:0};if(!r||0===r.length)return{overdue:[],today:[],thisWeek:[],upcoming:[],total:0};const i=r.map(e=>function(e){const t=new Date(e.next_review_at),n=e.last_practiced_at?new Date(e.last_practiced_at):void 0,r=function(e){const t=new Date,n=function(e){const t=new Date(e);return t.setHours(23,59,59,999),t}(t),r=function(e){const t=new Date(e),n=7-t.getDay();return t.setDate(t.getDate()+n),t.setHours(23,59,59,999),t}(t);if(e<t)return"overdue";if(e<=n)return"today";if(e<=r)return"this-week";return"upcoming"}(t),a="overdue"===r?function(e){const t=(new Date).getTime()-e.getTime(),n=Math.ceil(t/864e5);return Math.max(0,n)}(t):void 0;return{skillId:e.skill_id,masteryLevel:e.mastery_level,nextReviewAt:t,urgency:r,daysOverdue:a,lastPracticed:n}}(e)),o=function(e){const t=[],n=[],r=[],a=[];for(const i of e)switch(i.urgency){case"overdue":t.push(i);break;case"today":n.push(i);break;case"this-week":r.push(i);break;case"upcoming":a.push(i)}return{overdue:t,today:n,thisWeek:r,upcoming:a,total:e.length}}(i),s=Math.ceil(n/4);return{overdue:o.overdue.slice(0,s),today:o.today.slice(0,s),thisWeek:o.thisWeek.slice(0,s),upcoming:o.upcoming.slice(0,s),total:i.length}}function w(e){const t=new Date,n=new Date(Date.UTC(t.getUTCFullYear(),t.getUTCMonth(),t.getUTCDate())),r=new Date(Date.UTC(e.getUTCFullYear(),e.getUTCMonth(),e.getUTCDate())).getTime()-n.getTime(),a=Math.floor(r/864e5);if(a<0){const e=Math.abs(a);return 0===e?"today":1===e?"yesterday":`${e} days ago`}if(0===a)return"today";if(1===a)return"tomorrow";if(a<7)return`in ${a} days`;const i=Math.floor(a/7);if(1===i)return"in 1 week";if(i<4)return`in ${i} weeks`;const o=Math.floor(a/30);return 1===o?"in 1 month":`in ${o} months`}e(function(e,t){if(0===e.length)return{status:"insufficient-data",masteryLevel:0,message:"No attempts recorded"};if(e.length<c){return{status:"insufficient-data",masteryLevel:function(e){const t=e.filter(e=>e.correct).length,n=t/e.length*60;return Math.round(n)}(e),message:`Only ${e.length} attempts available (need ${c} for full calculation)`}}try{const n=function(e){if(0===e.length)return 0;const t=e.length;let n=0,r=0;for(let a=0;a<t;a++){const i=Math.exp(-.1*(t-1-a));n+=(e[a]?.correct?1:0)*i,r+=i}return r>0?n/r:0}(e),c=function(e,t){if(0===e.length)return.5;const{gradeRange:n,difficulty:r}=function(e){if(0===e.length)return{gradeRange:"0-3",difficulty:"A"};const t=new Map,n=new Map;for(const s of e){t.set(s.difficulty,(t.get(s.difficulty)??0)+1);const e=m(s.skillId);n.set(e,(n.get(e)??0)+1)}let r=0,a="A";t.forEach((e,t)=>{e>r&&(r=e,a=t)});let i=0,o="0-3";return n.forEach((e,t)=>{e>i&&(i=e,o=t)}),{gradeRange:o,difficulty:a}}(e),a=d[n][r],i=t.avgResponseTime/1e3;if(i<f)return.4;if(i>=a.min&&i<=a.expected)return 1;if(i>a.expected){const e=i-a.expected,t=a.max-a.expected,n=Math.min(e/t,2);return Math.max(.3,1-.5*n)}return 1}(e,t),u=function(e){if(0===e.length)return 1;const t=e.reduce((e,t)=>e+t.hintsUsed,0),n=t/e.length;return 0===n?1:n<=.5?.85:n<=1?.75:n<=2?.6:n<=3?.5:.4}(e),g=function(e){if(e.length<2)return.5;const t=e.map(e=>e.correct?1:0),n=t.reduce((e,t)=>e+t,0)/t.length,r=t.reduce((e,t)=>e+Math.pow(t-n,2),0)/t.length,a=Math.sqrt(r),i=1-a/.5;return Math.max(0,Math.min(1,i))}(e),h=function(e){const t=((new Date).getTime()-e.getTime())/864e5;if(t<1)return 1;const n=l,r=Math.exp(-Math.LN2*t/n);return Math.max(.05,r)}(t.lastPracticed),p=100*(n*r+c*a+u*i+g*o+h*s);return{status:"success",masteryLevel:Math.max(0,Math.min(100,Math.round(p)))}}catch(n){return{status:"error",message:n instanceof Error?n.message:"Unknown error during calculation"}}},{maxSize:200,keySerializer:e=>{const t=e[0],n=e[1];return`${t.slice(0,u).map(e=>`${e.correct?"1":"0"}${e.timeSpentSeconds}${e.hintsUsed}`).join("-")}_${`${n.skillId}_${n.lastPracticed?.getTime()||0}_${n.avgResponseTime||0}`}`}});export{g as a,h as c,w as f,y as g};
